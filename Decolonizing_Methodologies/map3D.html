<html>

<head>
    <title>Decolonising Methodologies influence map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"
        integrity="sha512-yocoLferfPbcwpCMr8v/B0AB4SWpJlouBwgE0D3ZHaiP1nuu5djZclFEIj9znuqghaZ3tdCMRrreLoM8km+jIQ=="
        crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="https://qonqr.com/Images/favicon.ico/android-icon-192x192.png" />
    <script src="https://unpkg.com/deck.gl@^8.2.0/dist.min.js"></script>
    <style>
        html,
        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            background: black;
        }
    </style>
</head>

<body>
    <script>
        function buildDescString(d) {
            console.log(d);
            return `<b>${d.name}</b><br>
            ${d.geo[0].formatted_address}<br>
            Citations: ${d.n_citations}<br>
            Papers: ${d.n_papers}<br>
            `;
        }

        var scale = chroma.scale('Spectral').domain([100, 0])
        var arcscale = chroma.scale('Spectral').domain([10, 0])

        $.getJSON("institutions.json", function (data) {
            console.warn("No lls for ", data.filter(d => !d.geo[0]))
            data = data.filter(d => d.geo[0])
            console.log(data)
            var lookup = {}
            for (var d of data) {
                d.position = [d.geo[0].geometry.location.lng, d.geo[0].geometry.location.lat]
                lookup[d.id] = d
            }
            var edges = [];
            for (var d of data) {
                for (var l in d.links) {
                    l = parseInt(l)
                    if (lookup[l]) {
                        edges.push({ from: d.position, to: lookup[l].position, count: d.links[l] })
                    }
                }
            }
            console.log(edges)
            const COUNTRIES = 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_scale_rank.geojson';
            var map = new deck.DeckGL({
                //mapStyle: deck.carto.BASEMAP.DARK_MATTER,
                views: new deck._GlobeView({ id: 'globe', controller: true }),
                initialViewState: {
                    longitude: 0,
                    latitude: 0,
                    zoom: 0,
                    pitch: 0
                },
                getTooltip: ({ object }) => object && {
                    html: buildDescString(object),
                    /*
                    style: {
                        "background-color": "white",
                        "color": "black"
                    }
                    */
                },
                layers: [
                    new deck.SolidPolygonLayer({
                        id: 'background',
                        data: [
                            // prettier-ignore
                            [[-180, 90], [0, 90], [180, 90], [180, -90], [0, -90], [-180, -90]]
                        ],
                        opacity: 1,
                        getPolygon: d => d,
                        stroked: false,
                        filled: true,
                        getFillColor: [5, 10, 40]
                    }),
                    new deck.GeoJsonLayer({
                        id: 'base-map',
                        data: COUNTRIES,
                        // Styles
                        stroked: true,
                        filled: true,
                        lineWidthMinPixels: 2,
                        getLineColor: [5, 10, 40],
                        getFillColor: [15, 40, 80]
                    }),
                    new deck.ScatterplotLayer({
                        id: "institutions",
                        data: data,
                        opacity: 0.5,
                        autoHighlight: true,
                        radiusScale: 10,
                        radiusMinPixels: 2,
                        wrapLongitude: true,
                        getPosition: d => d.position,
                        getFillColor: d => scale(d.n_citations).rgb(),
                        pickable: true,
                        getRadius: d => d.n_citations
                    }),
                    new deck.ArcLayer({
                        id: 'arc',
                        data: edges,
                        widthUnits: "pixels",
                        //widthMinPixels: .2,
                        getSourcePosition: e => e.from,
                        getTargetPosition: e => e.to,
                        getSourceColor: e => arcscale(e.count).rgb().concat(20),
                        getTargetColor: e => arcscale(e.count).rgb().concat(20),
                        getWidth: e => e.count
                    })
                ]
            });
        });
    </script>
</body>

</html>